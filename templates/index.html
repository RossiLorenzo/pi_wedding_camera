<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fliss&Lorenzo WeddingCam</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #slideshow-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            will-change: opacity;
        }

        .slide.active {
            opacity: 1;
            z-index: 2;
        }

        .slide.inactive {
            z-index: 1;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            letter-spacing: 1px;
            z-index: 10;
        }

        #watermark {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            z-index: 20;
            text-shadow: 0px 0px 4px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div id="slideshow-container">
        <div id="loading">Waiting for photos...</div>
        <img id="slide1" class="slide" src="" alt="">
        <img id="slide2" class="slide" src="" alt="">
        <div id="watermark">Fliss&Lorenzo WeddingCam</div>
    </div>

    <script>
        let images = [];
        let currentIndex = 0;
        let slideInterval;
        let activeSlideId = 'slide1';
        let inactiveSlideId = 'slide2';

        const SLIDE_DURATION = 5000; // 5 seconds
        const POLL_INTERVAL = 5000;  // Check for new photos every 5 seconds

        function fetchImages() {
            fetch('/api/images')
                .then(response => response.json())
                .then(newImages => {
                    const wasEmpty = images.length === 0;
                    const oldLatest = images.length > 0 ? images[0] : null;
                    const newLatest = newImages.length > 0 ? newImages[0] : null;

                    images = newImages;

                    if (images.length > 0) {
                        document.getElementById('loading').style.display = 'none';

                        if (wasEmpty) {
                            // First load
                            currentIndex = 0;
                            showImage(currentIndex);
                            startSlideshow();
                        } else if (newLatest && oldLatest && newLatest !== oldLatest) {
                            // New image detected! Show it immediately.
                            currentIndex = 0;
                            showImage(currentIndex);
                            resetSlideshow();
                        }
                    }
                })
                .catch(err => console.error('Error fetching images:', err));
        }

        function showImage(index) {
            if (index >= images.length) return;

            const filename = images[index];
            const url = `/images/${filename}`;

            const activeEl = document.getElementById(activeSlideId);
            const inactiveEl = document.getElementById(inactiveSlideId);

            // Prepare the inactive element (next slide)
            inactiveEl.src = url;

            inactiveEl.onload = () => {
                // Fade in new
                inactiveEl.classList.add('active');
                inactiveEl.classList.remove('inactive');

                // Fade out old
                activeEl.classList.remove('active');
                activeEl.classList.add('inactive');

                // Swap roles
                [activeSlideId, inactiveSlideId] = [inactiveSlideId, activeSlideId];
            };
        }

        function nextSlide() {
            if (images.length <= 1) return; // Don't cycle if 0 or 1 image

            currentIndex = (currentIndex + 1) % images.length;
            showImage(currentIndex);
        }

        function startSlideshow() {
            if (slideInterval) clearInterval(slideInterval);
            slideInterval = setInterval(nextSlide, SLIDE_DURATION);
        }

        function resetSlideshow() {
            startSlideshow();
        }

        // Initialize
        fetchImages();
        setInterval(fetchImages, POLL_INTERVAL);
    </script>
</body>
</html>
